name: Build Binary

on: { push: { branches-ignore: [main, production] } }

jobs:
  preprod-agent-deployment:
    name: Build and upload agent
    runs-on: ubuntu-latest
    container: golang:1.20
    env:
      BASE_NAME: spacelift-vcs-agent
      BIN_DIR: build

    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Mark source directory as safe. # This is some duct tape over the git version in the Go image complaining about this since one of the 1.19.x versions. Feel free to remove once it doesn't break the build anymore. See https://github.com/actions/runner/issues/2033 and https://github.com/actions/checkout/issues/760#issuecomment-1097797031
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: parse short SHA
        id: vars
        run: |
          echo ::set-output name=sha::$(git rev-parse --short=8 ${{ github.sha }})

      - name: Build Spacelift VCS Agent
        run: go build -a -tags netgo -ldflags "-s -w -extldflags '-static' -X main.VERSION=$SHORT_SHA -X main.BugsnagAPIKey=$BUGSNAG_API_KEY" -trimpath -o $BIN_DIR/$BASE_NAME ./cmd/spacelift-vcs-agent
        env:
          BUGSNAG_API_KEY: ${{ secrets.PREPROD_BUGSNAG_API_KEY }}
          CGO_ENABLED: 0
          SHORT_SHA: ${{ steps.vars.outputs.sha }}
